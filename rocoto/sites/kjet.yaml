# from kjet.ent

accounting:
  scheduler_settings:
    name: Slurm
    physical_cores_per_node: 32
    logical_cpus_per_core: 2
    hyperthreading_allowed: yes
    memory_per_node: !calc "63.5*1024"
  account: !calc all.CPU_ACCOUNT
  pe:
    queue: batch # queue for PE (parallel environment) jobs
    partition: kjet
    nodesize: 40
    account: !ref doc.accounting.account
  serial:
    queue: batch # queue for serial jobs
    partition: kjet
    account: !ref doc.accounting.account
  shared:
    queue: batch
    partition: kjet
    account: !ref doc.accounting.account
  service:
    queue: service
    partition: service
    account: !ref doc.accounting.account

resources:
  pure_openmp: !JobRequest
    - &resources_pure_openmp
      mpi_ranks: 0
      max_ppn: 1
      exclusive: true
      OMP_NUM_THREADS: !calc doc.accounting.threads
  serial: !JobRequest
    - &resources_small_serial
      mpi_ranks: 0
      max_ppn: 1
      exclusive: false
      memory: '1024M'
      queue: batch
  archive: !JobRequest
    - &resources_archive
      mpi_ranks: 0
      max_ppn: 1
      exclusive: false

  small_serial: !JobRequest:
    - <<: *resources_small_serial
      walltime: !timedelta '00:15:00'

  scrub_work: !JobRequest [ { <<: *resources_small_serial } ]
  scrub_com: !JobRequest [ { <<: *resources_small_serial } ]
  donefile: !JobRequest [ { <<: *resources_small_serial } ]

  input: !JobRequest [ { <<: *resources_archive }]
  archive_disk: !JobRequest [ { <<: *resources_archive }]
  archive_tape: !JobRequest [ { <<: *resources_archive }]
  archive_fv3out: !JobRequest [ { <<: *resources_archive }]

  grid: !JobRequest
    - mpi_ranks: 24
      OMP_NUM_THREADS: 6
      walltime: !timedelta '00:30:00'
      exclusive: true

  chgres_ic: !JobRequest
    - <<: *pure_openmp
      OMP_NUM_THREADS: 24
      exclusive: true
      walltime: !timedelta '00:30:00'

  chgres_bc: !JobRequest
    - OMP_NUM_THREADS: 24
      mpi_ranks: 504
      walltime: !timedelta '00:30:00'
      exclusive: true

  post: !JobRequest
    - OMP_NUM_THREADS: 1
      mpi_ranks: 72
      max_ppn: 24
      walltime: !timedelta '07:59:00'

  product: !JobRequest
    - OMP_NUM_THREADS: 1
      mpi_ranks: 2
      max_ppn: 24
      walltime: !timedelta '07:59:00'

  forecast_base: &forecast_base
    walltime: !timedelta '06:00:00'
    OMP_NUM_THREADS: 2
    exclusive: true
    max_ppn: 12

  forecast: !FirstTrue
    - when: all.FORECAST_RESOURCES=='regional_12x12io3x36_omp2'
      take: !JobRequest
        - <<: *forecast_base
          mpi_ranks: 252
    - when: all.FORECAST_RESOURCES=='regional_12x12io3x72_omp2'
      take: !JobRequest
        - <<: *forecast_base
          mpi_ranks: 360
    - when: all.FORECAST_RESOURCES=='regional_40x30io3x36_omp2'
      take: !JobRequest
        - <<: *forecast_base
          mpi_ranks: 1308
    - when: all.FORECAST_RESOURCES=='regional_40x30io3x72_omp2'
      take: !JobRequest
        - <<: *forecast_base
          mpi_ranks: 1416
    - when: all.FORECAST_RESOURCES=='regional_64x30io3x36_omp2'
      take: !JobRequest
        - <<: *forecast_base
          mpi_ranks: 2016
    - when: all.FORECAST_RESOURCES=='regional_64x30io3x72_omp2'
      take: !JobRequest
        - <<: *forecast_base
          mpi_ranks: 2124

    # FORECAST_RESOURCES for globnest HAFS
    - when: all.FORECAST_RESOURCES=='globnest_6x8x8_12x12io3x36_omp2'
      take: !JobRequest
        - <<: *forecast_base
          mpi_ranks: 636
    - when: all.FORECAST_RESOURCES=='globnest_6x8x8_12x12io3x72_omp2'
      take: !JobRequest
        - <<: *forecast_base
          mpi_ranks: 744
    - when: all.FORECAST_RESOURCES=='globnest_6x8x8_64x30io3x36_omp2'
      take: !JobRequest
        - <<: *forecast_base
          mpi_ranks: 2496
    - when: all.FORECAST_RESOURCES=='globnest_6x8x8_64x30io3x72_omp2'
      take: !JobRequest
        - <<: *forecast_base
          mpi_ranks: 2760
    - when: all.FORECAST_RESOURCES=='globnest_6x8x8_40x30io3x36_omp2'
      take: !JobRequest
        - <<: *forecast_base
          mpi_ranks: 1692
    - when: all.FORECAST_RESOURCES=='globnest_6x8x8_40x30io3x72_omp2'
      take: !JobRequest
        - <<: *forecast_base
          mpi_ranks: 1800
    - otherwise: !error "Don't know FORECAST_RESOURCES for {all.FORECAST_RESOURCES} on kjet"

